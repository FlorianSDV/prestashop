{"version":3,"sources":["../src/checkout.ts"],"sourcesContent":["declare global {\n  interface Window {\n    MyParcelConfig: MyParcelDeliveryOptions.Configuration;\n    // eslint-disable-next-line @typescript-eslint/naming-convention\n    myparcel_delivery_options_url: string;\n    prestashop: {\n      on: (name: string, callback: (event: Event) => void) => void;\n    };\n  }\n}\n\nimport {MyParcel, MyParcelDeliveryOptions} from '@myparcel/delivery-options';\n\n(() => {\n  /**\n   * Whether the listeners have been initialized.\n   */\n  let initialized = false;\n\n  /**\n   * @type {{}}\n   */\n  const deliveryOptionsConfigStore: Partial<\n    Record<\n      MyParcel.CarrierID,\n      {\n        data: MyParcelDeliveryOptions.Configuration;\n      }\n    >\n  > = {};\n\n  function createOrMoveDeliveryOptionsForm($wrapper: JQuery): void {\n    const $form = getDeliveryOptionsFormHandle();\n\n    if ($form) {\n      // Move the form to the new delivery option\n      $form.hide();\n      $wrapper.append($form);\n    } else {\n      // Or create the form container if it doesn't exist yet\n      $wrapper.html(`\n        <div id=\"myparcel-form-handle\">\n          <div class=\"loader\"></div>\n          <div id=\"myparcel-delivery-options\"></div>\n        </div>\n      `);\n    }\n  }\n\n  function getElement(selector: string): JQuery | null {\n    const element = $(selector);\n    return element.length ? element : null;\n  }\n\n  /**\n   * @param {Object} data\n   */\n  function updateInput(data) {\n    const $input = getInput();\n    const dataString = JSON.stringify(data);\n\n    $input.val(dataString);\n\n    const $checkoutDeliverStep = $('#checkout-delivery-step');\n\n    const isOnDeliverStep =\n      $checkoutDeliverStep.hasClass('js-current-step') || $checkoutDeliverStep.hasClass('-current');\n\n    if (isOnDeliverStep) {\n      $input.trigger('change');\n    }\n  }\n\n  /**\n   * @returns {jQuery|null}\n   */\n  function getDeliveryOptionsRow() {\n    const row = $('.delivery-option input:checked').closest('.delivery-option');\n    return row.length ? row : null;\n  }\n\n  /**\n   * @returns {jQuery}\n   */\n  function getInput(): JQuery {\n    let $input = $('#mypa-input');\n\n    if (!$input.length) {\n      $input = $('<input type=\"hidden\" id=\"mypa-input\" name=\"myparcel-delivery-options\" />');\n\n      const $wrapper = getDeliveryOptionsFormHandle();\n\n      if ($wrapper) {\n        $wrapper.append($input);\n      }\n    }\n\n    return $input;\n  }\n\n  function getDeliveryOptionsFormHandle(): JQuery | null {\n    return getElement('#myparcel-form-handle');\n  }\n\n  function hasUnRenderedDeliveryOptions(): boolean {\n    return Boolean(getElement('#myparcel-delivery-options'));\n  }\n\n  /**\n   * @param {string} carrierId\n   */\n  function updateConfig(carrierId: MyParcel.CarrierID) {\n    const hasCarrierConfig = deliveryOptionsConfigStore.hasOwnProperty(carrierId);\n\n    if (!hasCarrierConfig) {\n      void $.ajax({\n        url: `${window.myparcel_delivery_options_url}?carrier_id=${carrierId}`,\n        dataType: 'json',\n        async: false,\n        success: function (data) {\n          deliveryOptionsConfigStore[carrierId] = data;\n\n          window.MyParcelConfig = deliveryOptionsConfigStore[carrierId]?.data ?? window.MyParcelConfig;\n          updateDeliveryOptions();\n        },\n      });\n    }\n\n    window.MyParcelConfig = deliveryOptionsConfigStore[carrierId]?.data ?? window.MyParcelConfig;\n  }\n\n  /**\n   * @param {jQuery} $deliveryOptionsRow\n   */\n  function initializeMyParcelForm($deliveryOptionsRow: JQuery) {\n    if (!$deliveryOptionsRow || !$deliveryOptionsRow.length || !$deliveryOptionsRow.find('input:checked')) {\n      return;\n    }\n\n    const carrierId = $deliveryOptionsRow.find('input:checked')[0].value.split(',').join('');\n    const $wrapper = $deliveryOptionsRow.next().find('.myparcel-delivery-options-wrapper');\n\n    if (!$wrapper) {\n      return;\n    }\n\n    createOrMoveDeliveryOptionsForm($wrapper);\n    updateConfig(carrierId);\n    updateDeliveryOptions();\n  }\n\n  /**\n   *\n   */\n  function updateDeliveryOptions() {\n    if (hasUnRenderedDeliveryOptions()) {\n      document.dispatchEvent(new Event('myparcel_render_delivery_options'));\n    } else {\n      document.dispatchEvent(new Event('myparcel_update_config'));\n    }\n  }\n\n  /**\n   * Initialize all listeners.\n   */\n  function start() {\n    if (initialized) {\n      return;\n    }\n\n    initialized = true;\n\n    window.prestashop.on('updatedDeliveryForm', (event) => {\n      initializeMyParcelForm(event.deliveryOption);\n    });\n\n    initializeMyParcelForm(getDeliveryOptionsRow());\n\n    document.addEventListener('myparcel_updated_delivery_options', (event) => {\n      getDeliveryOptionsFormHandle().slideDown();\n\n      if (event.detail) {\n        updateInput(event.detail);\n      }\n    });\n  }\n\n  document.addEventListener('DOMContentLoaded', () => {\n    if (!document.querySelector('#checkout-delivery-step.js-current-step')) {\n      window.prestashop.on('changedCheckoutStep', start);\n      return;\n    }\n\n    start();\n  });\n\n  // Hack to keep prestashop from hiding the checkout when icons inside the delivery options are clicked.\n  window.prestashop.on('changedCheckoutStep', (values) => {\n    const $currentTarget = $(values.event.currentTarget);\n\n    if (!$currentTarget.hasClass('-current')) {\n      const $activeStep = $('.checkout-step.-current');\n\n      if (!$activeStep.length) {\n        $currentTarget.addClass('-current');\n        $currentTarget.addClass('js-current-step');\n      }\n    }\n  });\n})();\n"],"mappings":"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","names":["_a","_b"]}